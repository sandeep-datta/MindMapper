<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="lib/jquery.js"></script>
	<script type="text/javascript" src="lib/textile.js"></script>
	<script type="text/javascript" src="lib/html2canvas.js"></script>
</head>

<body>
<p>
	<div id="target" ></div>
</p>
<p>
	<canvas id="target2" style="border:2px solid black;" width="1600" height="400"></canvas>
</p>
<p>
	<div id="temp" style="width:400"></div>
</p>
<p>
	<textarea id="editor" style="border:2px solid black;" width="800" height="200"></textarea>
</p>
<script>

function render(html) {
	var canvas = document.getElementById("target2");
	var ctx = canvas.getContext("2d");
	var data = "<svg xmlns='http://www.w3.org/2000/svg' width='1600' height='400'>" +
	             "<foreignObject width='100%' height='100%'>" +
	               "<div xmlns='http://www.w3.org/1999/xhtml'>" +
	                 html +
	               "</div>" +
	             "</foreignObject>" +
	           "</svg>";
	var DOMURL = self.URL || self.webkitURL || self;
	var img = new Image();
	var svg = new Blob([data], {type: "image/svg+xml;charset=utf-8"});
	var url = DOMURL.createObjectURL(svg);
	img.onload = function() {
		ctx.clearRect(0,0, canvas.width, canvas.height);
	    ctx.drawImage(img, 0, 0);
	    DOMURL.revokeObjectURL(url);
	};
	img.src = url;
}

$(document).ready(function () {
    init();
});

function init() {
    var $content = $('#editor'); // my textarea
    var $target = $('#target'); // the preview div
    var $temp = $('#temp');

    // use a simple timer to check if the textarea content has changed
    var value = $content.val();

    setInterval(function () {
        var newValue = $content.val();
        if (value != newValue) {
            value = newValue;
            var html = textile.convert(newValue);

            $temp.empty();
            $temp.append($.parseHTML(html));

            render(html);

            html2canvas($temp, {
	            	onrendered: function(canvas) {
	            		$target.empty();
	            		$target.append(canvas);
	            	}
            	}
            ); // convert the textile to html
        }
    }, 500);
};
</script>
</body>
</html>